@using Utility.DBInitializer
@model IEnumerable<Entities.Models.Material>
@{
    ViewData["Title"] = "Labs";
    Layout = "~/Views/Shared/_CourseLayout.cshtml";
    var courseId = ViewData["CourseId"];
    var color = ViewData["Color"]?.ToString() ?? "#198754"; // أخضر
}

@if (User.IsInRole(SD.Assistant))
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold" style="color:@color;">🧪 Labs</h2>
        <a asp-action="AddMaterial" asp-controller="DoctorsAndAssistant" asp-area="Customer" asp-route-courseId="@courseId" asp-route-color="@color" class="btn btn-success d-flex align-items-center gap-2 shadow-sm rounded-pill px-3">
            <i class="bi bi-plus-circle"></i> Add Lab
        </a>
    </div>
}

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info text-center shadow-sm rounded">
        <i class="bi bi-info-circle"></i> No labs available for this course.
    </div>
}
else
{
    <div class="row g-4">
        @foreach (var item in Model)
        {
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 hover-shadow transition">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">
                            <i class="bi bi-beaker me-2 text-success"></i> Lab @item.Id
                        </h5>
                        <p class="card-text text-muted mb-2">Uploaded on: @item.UploadDate:dd/MM/yyyy</p>
                        <p class="card-text small text-secondary">
                            @if (item.Assistant != null)
                            {
                                <span><i class="bi bi-person"></i> Assistant @item.Assistant.ApplicationUser.FullName</span>
                            }
                        </p>
                        <a href="@item.MaterialLink" target="_blank" class="btn btn-outline-success w-100 rounded-pill">
                            <i class="bi bi-box-arrow-up-right"></i> Open Lab
                        </a>

                        @if (User.IsInRole(SD.Assistant))
                        {
                            <div class="dropdown text-end mt-2">
                                <button class="btn btn-sm btn-light rounded-circle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a asp-action="EditMaterial" asp-controller="DoctorsAndAssistant" asp-area="Customer" asp-route-id="@item.Id" asp-route-color="@color" class="dropdown-item">
                                            <i class="bi bi-pencil-square text-warning"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" class="dropdown-item text-danger btn-delete" data-delete-url="@Url.Action("DeleteMaterial", "DoctorsAndAssistant", new { area = "Customer", id = item.Id })">
                                            <i class="bi bi-trash"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("click", function(e){
            const target = e.target.closest(".btn-delete");
            if (!target) return;
            e.preventDefault();
            const deleteUrl = target.getAttribute("data-delete-url");
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => { if(result.isConfirmed) window.location.href = deleteUrl; });
        });
    </script>
}
